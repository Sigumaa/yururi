# メジャーアップデート方針 v1

## 目的
1. 会話継続性と安全性を同時に改善する。
2. 実行責務を分離し、障害時の切り分けを容易にする。
3. 運用中の不要投稿と重複投稿を抑止する。

## 適用範囲
1. Discord受信から応答反映までの実行系。
2. 4軸Markdown（`YURURI.md` / `SOUL.md` / `MEMORY.md` / `HEARTBEAT.md`）の更新系。
3. MCP tool 呼び出し制御系。

## 方針
### 1. 会話管理の分離
1. `dispatcher`は受信・フィルタ・投入のみ担当する。
2. `orchestrator`は`channel_key`単位のセッションと直列キューのみ担当する。
3. `ai runtime`は判断と`DecisionResult`生成のみ担当する。
4. Discord書き込み実行は`gateway`に限定し、他層から直接送信しない。

### 2. 3層メモリ
1. `Turn Memory`は当該ターン限定の一時文脈として扱い、ターン終了時に破棄する。
2. `Session Memory`はチャンネル単位状態（`thread_id` / `turn_id` / 重複抑止キャッシュ）を保持する。
3. `Persistent Memory`は4軸Markdownのみとし、会話本文を保存しない。
4. 永続更新は毎ターン必須にせず、長期再利用価値がある新情報のみ反映する。

### 3. MCP最小化
1. MCPは既定拒否とし、許可toolをallowlistで明示する。
2. 1ターンあたりのtool呼び出し回数は上限を設ける（既定3回）。
3. 同一引数での再試行は1回までとする。
4. 呼び出しごとに目的・結果・所要時間を構造化ログへ記録する。

### 4. チャンネル read/write 分離
1. `read_channel_ids[]`と`write_channel_ids[]`を分離定義する。
2. `write_channel_ids[]`は`read_channel_ids[]`の部分集合とする。
3. 書き込み系操作（send/reply/react/edit/delete）は`write_channel_ids[]`のみ許可する。
4. read-onlyチャンネルでの書き込み要求は`noop`へ変換する。

### 5. Bot自認
1. システム指示に「本アカウントはBotである」を固定で含める。
2. 出自・権限を問う質問にはBotであることを明示して回答する。
3. 人間を装う表現、未実施行為の実体験化、権限誤認を禁止する。

### 6. 重複抑止
1. 送信前に本文を正規化（空白正規化・小文字化）してハッシュ化する。
2. チャンネル単位の抑止ウィンドウ内で同一ハッシュ再送を禁止する。
3. heartbeat/autonomy/retryの全経路に同一ルールを適用する。
4. 重複検知時は送信せず`noop`とし、抑止理由をログ出力する。

## 受け入れ基準
1. 同一チャンネル同時入力で応答順序が崩れない。
2. 永続層へ会話本文が保存されない。
3. read-onlyチャンネルで書き込みが発生しない。
4. Bot自認に反する出力が運用テストで検出される。
5. 重複投稿が抑止され、抑止ログで追跡できる。
